version: '3.8'

services:
  # MongoDB service for admin and tenant databases
  mongodb:
    image: mongo:7.0
    container_name: multi-tenant-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin123}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - multi-tenant-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # Application service
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: multi-tenant-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-5000}:5000"
    environment:
      # Admin Database URI
      ADMIN_DB_URI: ${ADMIN_DB_URI:-mongodb://admin:admin123@mongodb:27017/admin_db?authSource=admin}
      # JWT Secret
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      # Bcrypt salt rounds
      SALT_ROUNDS: ${SALT_ROUNDS:-10}
      # Node environment
      NODE_ENV: ${NODE_ENV:-production}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - multi-tenant-network
    # volumes:
    #   # Mount source code for development (uncomment for development)
    #   - ./:/app
    #   - /app/node_modules

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

networks:
  multi-tenant-network:
    driver: bridge

